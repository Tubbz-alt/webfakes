<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to use presser in your tests • presser</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to use presser in your tests">
<meta property="og:description" content="presser">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">presser</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.1.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/introduction.html">Intro</a>
</li>
<li>
  <a href="../articles/how-to.html">How-to</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../httpbin.html">The builtin httpbin app's API</a>
    </li>
    <li>
      <a href="../articles/internals.html">Presser internals</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/presser/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="how-to_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How to use presser in your tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/presser/blob/master/vignettes/how-to.Rmd"><code>vignettes/how-to.Rmd</code></a></small>
      <div class="hidden name"><code>how-to.Rmd</code></div>

    </div>

    
    
<div id="how-do-i-use-presser-in-my-package" class="section level2">
<h2 class="hasAnchor">
<a href="#how-do-i-use-presser-in-my-package" class="anchor"></a>How do I use presser in my package?</h2>
<p>First, you need to add presser to the <code>DESCRIPTION</code> file of your package. Use the <code>Suggests</code> field, as presser is only needed for testing:</p>
<pre><code>...
Suggests:
  presser,
  testthat
...</code></pre>
<p>Then you need to decide if you want a single web app for all your test cases. The alternative is to use different apps for some or all test files. Occasionally you may want to use a special app for a single test case. Each app runs in a new subprocess, and it takes typically about 100-400ms to start.</p>
<p>See the sections below on writing tests with a single app or multiple apps.</p>
</div>
<div id="how-do-i-use-httpbin_app-or-another-app-with-testthat" class="section level2">
<h2 class="hasAnchor">
<a href="#how-do-i-use-httpbin_app-or-another-app-with-testthat" class="anchor"></a>How do I use <code>httpbin_app()</code> (or another app) with testthat?</h2>
<p>You can use testthat’s setup and teardown files. You start the app in a setup file and stop it in a teardown file. See <code><a href="https://testthat.r-lib.org/reference/source_file.html">?testthat::source_file</a></code>. Your <code>tests/testthat/setup-http.R</code> may look like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="va">http</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span><span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/httpbin_app.html">httpbin_app</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Your <code>tests/testthat/teardown-http.R</code> will be</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">http</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span></pre></div>
<p>In the test cases you can query the <code>http</code> app process to get the URLs you need to connect to:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="fu">test_that</span><span class="op">(</span><span class="st">"fails on 404"</span>, <span class="op">{</span>
  <span class="va">url</span> <span class="op">&lt;-</span> <span class="va">http</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/status/404"</span><span class="op">)</span>
  <span class="va">response</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span>
  <span class="fu">expect_error</span><span class="op">(</span>
    <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/stop_for_status.html">stop_for_status</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span>,
    class <span class="op">=</span> <span class="st">"http_404"</span>
  <span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>When writing your tests interactively, you may create a <code>http</code> app process in the global environment, for convenience. You can <code><a href="https://rdrr.io/r/base/source.html">source()</a></code> your <code>setup-http.R</code> file for this.</p>
</div>
<div id="how-to-make-sure-that-my-code-works-with-the-real-api" class="section level2">
<h2 class="hasAnchor">
<a href="#how-to-make-sure-that-my-code-works-with-the-real-api" class="anchor"></a>How to make sure that my code works with the <em>real</em> API?</h2>
<p>Indeed, if you use presser for your test cases, then they never touch the real web server. As you might suspect, this is not ideal, especially when you do not control the server. The web service might change their API, and your test cases will fail to warn you.</p>
<p>One practical solution is to write (at least some) flexible tests, that can run against a local fake webserver, or a real one, and you have a quick switch to change their behavior. I have found that environment variables work great for this.</p>
<p>E.g. if the <code>FAKE_HTTP_TESTS</code> environment variable is not set, the tests run with the real web server, otherwise they use a fake one. Another solution, that works best is the HTTP requests are in the downstream package code, is to introduce one environment variable for each API you need to connect to. These might be set to the real API servers, or to the fake ones.</p>
<p>Once you have some tests that can use both kinds or servers, you can set up your continuous integration (CI) framework, to run the tests agains the real server (say) once a day. This special CI run makes sure that your code works well with the real API. You can run all the other tests, locally and in the CI, against the fake local web server.</p>
<p>See the next question for how presser helps you setting environment variables that point to your local server.</p>
</div>
<div id="how-do-i-test-a-sequence-of-requests" class="section level2">
<h2 class="hasAnchor">
<a href="#how-do-i-test-a-sequence-of-requests" class="anchor"></a>How do I test a sequence of requests?</h2>
<p>To test a sequence of requests, the app needs state information that is kept between requests. <code>app$locals</code> is an environment that belongs to the app, and it can be used to record information and then retreive it in future requests. E.g. here is an end point that fails three times, then succeeds once, fails again three times, etc.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">retry</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app.html">new_app</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">retry</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/unstable"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">app</span><span class="op">$</span><span class="va">locals</span><span class="op">$</span><span class="va">counter</span>, <span class="fl">3L</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">res</span><span class="op">$</span><span class="va">app</span><span class="op">$</span><span class="va">locals</span><span class="op">$</span><span class="va">counter</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
    <span class="va">res</span><span class="op">$</span><span class="fu">send_json</span><span class="op">(</span>object <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>result <span class="op">=</span> <span class="st">"ok"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">res</span><span class="op">$</span><span class="va">app</span><span class="op">$</span><span class="va">locals</span><span class="op">$</span><span class="va">counter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">app</span><span class="op">$</span><span class="va">locals</span><span class="op">$</span><span class="va">counter</span>, <span class="fl">0L</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1L</span>
    <span class="va">res</span><span class="op">$</span><span class="fu">send_status</span><span class="op">(</span><span class="fl">401</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>Let’s run this app in another process and connect to it:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span><span class="va">retry</span><span class="op">)</span>
<span class="va">url</span> <span class="op">&lt;-</span> <span class="va">pr</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/unstable"</span><span class="op">)</span>
<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span>
<span class="co">#&gt; Response [http://127.0.0.1:49470/unstable]</span>
<span class="co">#&gt;   Date: 2020-10-16 14:34</span>
<span class="co">#&gt;   Status: 401</span>
<span class="co">#&gt;   Content-Type: text/plain</span>
<span class="co">#&gt; &lt;EMPTY BODY&gt;</span>
<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span>
<span class="co">#&gt; Response [http://127.0.0.1:49470/unstable]</span>
<span class="co">#&gt;   Date: 2020-10-16 14:34</span>
<span class="co">#&gt;   Status: 401</span>
<span class="co">#&gt;   Content-Type: text/plain</span>
<span class="co">#&gt; &lt;EMPTY BODY&gt;</span>
<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span>
<span class="co">#&gt; Response [http://127.0.0.1:49470/unstable]</span>
<span class="co">#&gt;   Date: 2020-10-16 14:34</span>
<span class="co">#&gt;   Status: 401</span>
<span class="co">#&gt;   Content-Type: text/plain</span>
<span class="co">#&gt; &lt;EMPTY BODY&gt;</span>
<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span>
<span class="co">#&gt; Response [http://127.0.0.1:49470/unstable]</span>
<span class="co">#&gt;   Date: 2020-10-16 14:34</span>
<span class="co">#&gt;   Status: 200</span>
<span class="co">#&gt;   Content-Type: application/json</span>
<span class="co">#&gt;   Size: 17 B</span></pre></div>
</div>
<div id="how-do-i-make-my-app-connect-to-presser-when-the-tests-are-running" class="section level2">
<h2 class="hasAnchor">
<a href="#how-do-i-make-my-app-connect-to-presser-when-the-tests-are-running" class="anchor"></a>How do I make my app connect to presser when the tests are running?</h2>
<p>In the typical scenario, you want your package to connect to the test app only when running the tests. One way to achieve this is to allow specifying the web server URL(s) via environment variables. E.g. when writing a GitHub API client, your package can check use <code>GITHUB_URL</code> environment variable. When this is not set, the package connects to the proper GitHub API. When testing, you can point it to your test app.</p>
<p><code><a href="../reference/new_app_process.html">new_app_process()</a></code> helps you setting up temporary environment variables. These are active while the process is running, and they are removed or reset in <code>$stop()</code>. For example:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">http</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span><span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/httpbin_app.html">httpbin_app</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">http</span><span class="op">$</span><span class="fu">local_env</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>GITHUB_API <span class="op">=</span> <span class="va">http</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"GITHUB_API"</span><span class="op">)</span>
<span class="co">#&gt; [1] "http://127.0.0.1:49475/"</span>
<span class="va">http</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"GITHUB_API"</span><span class="op">)</span>
<span class="co">#&gt; [1] ""</span></pre></div>
</div>
<div id="how-can-i-write-my-own-app" class="section level2">
<h2 class="hasAnchor">
<a href="#how-can-i-write-my-own-app" class="anchor"></a>How can I write my own app?</h2>
<p>You create a new app with <code><a href="../reference/new_app.html">new_app()</a></code>. This returns an object with methods to add middleware and API endpoints to it. For example, a simple app that returns the current time in JSON would look like this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">time</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app.html">new_app</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">time</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/time"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">res</span><span class="op">$</span><span class="fu">send_json</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, auto_unbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>Now you can start this app on a random port using <code>web$listen()</code>. Alternatively, you can start it in a subprocess with <code><a href="../reference/new_app_process.html">new_app_process()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">web</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>
<span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "http://127.0.0.1:49476/"</span></pre></div>
<p>Use <code>web$url()</code> to query the URL of the app. For example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">url</span> <span class="op">&lt;-</span> <span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/time"</span><span class="op">)</span>
<span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $time</span>
<span class="co">#&gt; [1] "2020-10-16 14:34:26"</span></pre></div>
<p><code>web$stop()</code> stops the app and the subprocess as well:</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">web</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span>
<span class="va">web</span><span class="op">$</span><span class="fu">get_state</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "not running"</span></pre></div>
<p>You can create your app at the beginning of your test file. Or, if you want to use the same app in multiple test files, use a testthat helper file. Sometimes it useful if your users can create and use your test app, for example to create reproducible examples. You can include a (possibly internal) function in your package, that creates the app.</p>
<p>See <code>?new_app()</code> and <code>?new_app_process()</code> for more details.</p>
</div>
<div id="can-i-have-an-app-for-a-single-testthat-test-file" class="section level2">
<h2 class="hasAnchor">
<a href="#can-i-have-an-app-for-a-single-testthat-test-file" class="anchor"></a>Can I have an app for a single testthat test file?</h2>
<p>To run a web app for a single test file, start it in <code><a href="https://testthat.r-lib.org/reference/teardown.html">testthat::setup()</a></code> and stop it in <code><a href="https://testthat.r-lib.org/reference/teardown.html">testthat::teardown()</a></code>. You can do this at the beginning of the file:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="va">web</span> <span class="op">&lt;-</span> <span class="fu">setup</span><span class="op">(</span><span class="op">{</span>
  <span class="va">app</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app.html">new_app</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">app</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/hello/:user"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">res</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">req</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">user</span>, <span class="st">"!"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
  <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span><span class="va">app</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="fu">teardown</span><span class="op">(</span><span class="va">web</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Then in the test cases, use <code>web$url()</code> to get the URL to connect to.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu">test_that</span><span class="op">(</span><span class="st">"can use hello API"</span>, <span class="op">{</span>
  <span class="va">url</span> <span class="op">&lt;-</span> <span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/hello/Gabor"</span><span class="op">)</span>
  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Hello Gabor!"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
</div>
<div id="can-i-use-an-app-for-a-single-testthat-test" class="section level2">
<h2 class="hasAnchor">
<a href="#can-i-use-an-app-for-a-single-testthat-test" class="anchor"></a>Can I use an app for a single testthat test?</h2>
<p>Sure. For this you need to create the app process within the <code><a href="https://testthat.r-lib.org/reference/test_that.html">testthat::test_that()</a></code> test case and use <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code> to stop it. It goes like this:</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu">test_that</span><span class="op">(</span><span class="st">"query works"</span>, <span class="op">{</span>
  <span class="va">app</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app.html">new_app</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">app</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/hello"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="va">res</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"hello there"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">web</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">web</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span><span class="va">app</span><span class="op">)</span>

  <span class="va">echo</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op">(</span><span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/GET.html">GET</a></span><span class="op">(</span><span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/hello"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">echo</span>, <span class="st">"hello there"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
</div>
<div id="how-can-i-to-debug-an-app" class="section level2">
<h2 class="hasAnchor">
<a href="#how-can-i-to-debug-an-app" class="anchor"></a>How can I to debug an app?</h2>
<p>To debug an app, it is best to run it in the main R process, i.e. <em>not</em> via <code><a href="../reference/new_app_process.html">new_app_process()</a></code>. You can add breakpoints, or <code><a href="https://rdrr.io/r/base/browser.html">browser()</a></code> calls to your handler functions, and then invoke your app from another process. You might find the <code>curl</code> command line tool to send HTTP requests to the app, or you can just use another R process. Here is an example. We will simply print the incoming request object to the screen now. For a real debugging session you probably want to place a <code><a href="https://rdrr.io/r/base/browser.html">browser()</a></code> command there.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">app</span> <span class="op">&lt;-</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app.html">new_app</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">app</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"/debug"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">req</span><span class="op">)</span>
  <span class="va">res</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"Got your back"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></pre></div>
<p>Now start the app on port 3000:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="va">app</span><span class="op">$</span><span class="fu">listen</span><span class="op">(</span>port <span class="op">=</span> <span class="fl">3000</span><span class="op">)</span></pre></div>
<pre><code>#&gt; Running presser web app on port 3000</code></pre>
<p>Connect to the app from another R or <code>curl</code> process:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">curl</span> -v http://127.0.0.1:3000/debug</span></code></pre></div>
<pre><code>#&gt; *   Trying 127.0.0.1...
#&gt; * TCP_NODELAY set
#&gt; * Connected to 127.0.0.1 (127.0.0.1) port 3000 (#0)
#&gt; &gt; GET /debug HTTP/1.1
#&gt; &gt; Host: 127.0.0.1:3000
#&gt; &gt; User-Agent: curl/7.54.0
#&gt; &gt; Accept: */*
#&gt; &gt;
#&gt; &lt; HTTP/1.1 200 OK
#&gt; &lt; Content-Type: text/plain
#&gt; &lt; Content-Length: 13
#&gt; &lt;
#&gt; * Connection #0 to host 127.0.0.1 left intact
#&gt; Got your back</code></pre>
<p>Your main R session will print the incoming request:</p>
<pre><code>#&gt; &lt;presser_request&gt;
#&gt; method:
#&gt;   get
#&gt; url:
#&gt;   http://127.0.0.1:3000/debug
#&gt; client:
#&gt;   127.0.0.1
#&gt; query:
#&gt; headers:
#&gt;   Host: 127.0.0.1:3000
#&gt;   User-Agent: curl/7.54.0
#&gt;   Accept: */*
#&gt; fields and methods:
#&gt;   app                    # the presser_app the request belongs to
#&gt;   headers                # HTTP request headers
#&gt;   hostname               # server hostname, the Host header
#&gt;   method                 # HTTP method of request (lowercase)
#&gt;   path                   # server path
#&gt;   protocol               # http or https
#&gt;   query_string           # raw query string without '?'
#&gt;   query                  # named list of query parameters
#&gt;   remote_addr            # IP address of the client
#&gt;   url                    # full URL of the request
#&gt;   get_header(field)      # get a request header
#&gt;  # see ?presser_request for details</code></pre>
<p>Press <code>CTRL+C</code> or <code>ESC</code> to interrupt the app in the main session.</p>
</div>
<div id="can-i-test-asynchronous-or-parallel-http-requests" class="section level2">
<h2 class="hasAnchor">
<a href="#can-i-test-asynchronous-or-parallel-http-requests" class="anchor"></a>Can I test asynchronous or parallel HTTP requests?</h2>
<p>R is single threaded and a presser app runs an R interpreter, so it cannot process multiple requests at the same time. The web server itself runs in a separate thread, and it can also process each request in a separate thread, but at any time only one request can use the R interpreter.</p>
<p>This is important, because sometimes test requests may take longer to process. For example the <code>/delay/:secs</code> end point of <code><a href="../reference/httpbin_app.html">httpbin_app()</a></code> wait for the specified number of seconds before responding, to simulate a slow web server. If this wait is implemented via the standard <code><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep()</a></code> R function, then no other requests can be processed until the sleep is over. To avoid this, presser can put the waiting request on hold, return from the R interpreter, and respond to other incoming requests. Indeed, the <code>/delay/</code> end point is implemented using this feature.</p>
<p>However, the request thread of the web server is still busy while on hold, so to take advantage of this, you need to allow multiple threads. The <code>num_threads</code> argument of the <code>$listen()</code> method of <code>presser_app</code> lets you specify the number of request threads the web server will use. Similarly, the <code>num_threads</code> argument of <code><a href="../reference/new_app_process.html">new_app_process()</a></code> lets you modify the number of threads.</p>
<p>When testing asynchronous or parallel code, that might invoke multiple, possibly delayed requests, it is best to increase the number of threads. The code below calls the same API request concurrently, three times. Each request takes 1 second to answer, but if the web server has more than three threads, together they’ll still take about 1 second.</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="va">web</span> <span class="op">&lt;-</span> <span class="fu">setup</span><span class="op">(</span>
  <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/new_app_process.html">new_app_process</a></span><span class="op">(</span>
    <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/httpbin_app.html">httpbin_app</a></span><span class="op">(</span><span class="op">)</span>,
    opts <span class="op">=</span> <span class="fu">presser</span><span class="fu">::</span><span class="fu"><a href="../reference/server_opts.html">server_opts</a></span><span class="op">(</span>num_threads <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="fu">teardown</span><span class="op">(</span><span class="va">web</span><span class="op">$</span><span class="kw">stop</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="fu">test_that</span><span class="op">(</span><span class="st">""</span>, <span class="op">{</span>
  <span class="va">url</span> <span class="op">&lt;-</span> <span class="va">web</span><span class="op">$</span><span class="fu">url</span><span class="op">(</span><span class="st">"/delay/1"</span><span class="op">)</span>
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.cran.dev/curl/reference/multi.html">new_pool</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">handles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.cran.dev/curl/reference/handle.html">new_handle</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">url</span><span class="op">)</span><span class="op">)</span>
  <span class="va">resps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">handle</span> <span class="kw">in</span> <span class="va">handles</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.cran.dev/curl/reference/multi.html">multi_add</a></span><span class="op">(</span>
      <span class="va">handle</span>,
      done <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"one is done"</span><span class="op">)</span>,
      fail <span class="op">=</span> <span class="va">stop</span>,
      pool <span class="op">=</span> <span class="va">p</span>
    <span class="op">)</span>
  <span class="op">}</span>
  <span class="va">st</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu">curl</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.cran.dev/curl/reference/multi.html">multi_run</a></span><span class="op">(</span>timeout <span class="op">=</span> <span class="fl">5</span>, pool <span class="op">=</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">st</span><span class="op">)</span>
  <span class="fu">expect_true</span><span class="op">(</span><span class="va">st</span><span class="op">[[</span><span class="st">"elapsed"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">3.0</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.002   0.001   1.406</span></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/gaborcsardi">Gábor Csárdi</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
